{{/* layouts/shortcodes/gallery.html */}}
{{- $baseURL := .Site.BaseURL -}}
{{- $arg := .Get 0 -}}
{{- $imgRE := "\\.(gif|jpg|jpeg|tiff|png|bmp|webp|avif|jxl|JPG|PNG|GIF)$" -}}

<div class="gallery-photos">

  {{- if or (hasPrefix $arg "http://") (hasPrefix $arg "https://") -}}
    {{/* --- URL 列表模式：支持 "url" "描述" 成对写法 --- */}}
    {{- $.Scratch.Set "skip" -1 -}}
    {{- range $i, $p := .Params -}}
      {{- if ne ($.Scratch.Get "skip") $i -}}
        {{- $url := $p -}}
        {{- if (findRE $imgRE $url) -}}
          {{- $desc := "" -}}
          {{- $nextIndex := add $i 1 -}}
          {{- if lt $nextIndex (len $.Params) -}}
            {{- $next := index $.Params $nextIndex -}}
            {{- if not (findRE $imgRE $next) -}}
              {{- $desc = $next -}}
              {{- $.Scratch.Set "skip" $nextIndex -}}
            {{- end -}}
          {{- end -}}
          <figure class="gallery-photo {{ if $desc }}has-caption{{ end }}">
            <img class="photo-img" loading="lazy" decoding="async" src="{{ $url }}" alt="photo" />
            {{- if $desc -}}
              <figcaption class="photo-title">{{ $desc | markdownify }}</figcaption>
            {{- end -}}
          </figure>
        {{- end -}}
      {{- end -}}
    {{- end -}}

  {{- else -}}
    {{/* --- 目录模式（原逻辑保留，仅把 span 换 figcaption 更语义化） --- */}}
    {{- with $arg -}}
      {{- $files := readDir (print "/static/" .) -}}
      {{- range (sort $files "Name" "desc") -}}
        {{- if ( .Name | findRE $imgRE ) -}}
          {{- $linkURL := print $baseURL "/" $arg "/" .Name | absURL -}}
          <figure class="gallery-photo">
            <img class="photo-img" loading="lazy" decoding="async" src="{{ $linkURL }}" alt="{{ .Name }}" />
            <figcaption class="photo-title" style="display:none;">{{ .Name | replaceRE "\\..*" "" }}</figcaption>
          </figure>
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

</div>

<style>
  .gallery-photos{ width:100%; bottom:10px;}
  .gallery-photo{ width:33%; position:relative; visibility:hidden; overflow:hidden; border-radius:20px; margin:0; }
  .gallery-photo.visible{ visibility:visible; animation:fadeIn 2s; }
  .gallery-photo img{ display:block; width:100%; margin:6px; border-radius:20px; animation:fadeIn 1s; cursor:pointer; transition:all .4s ease-in-out; }

  /* 默认不显示标题；只有有描述时才显示 */
  .gallery-photo .photo-title{ display:none; }
  .gallery-photo.has-caption .photo-title {
    display:block;
    padding:3px 5px;
    font-size:0.9rem;
    font-weight:bold;
    color:#121316;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);  /* 加点阴影增强可读性 */
  }


  @media screen and (max-width:860px){ .gallery-photo{ width:49.9%; } }
  @media (max-width:683px){ .gallery-photo{ width:100%; } }
  @keyframes fadeIn{ 0%{opacity:0;} 100%{opacity:1;} }
</style>

<script src="https://immmmm.com/waterfall.min.js"></script>
<script src="https://immmmm.com/imgStatus.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const galleries = document.querySelectorAll('.gallery-photos');
  if(!galleries.length) return;
  imgStatus.watch('.gallery-photo img', (imgs) => {
    if(imgs.isDone()){
      galleries.forEach(g => {
        waterfall(g);
        g.querySelectorAll('.gallery-photo').forEach(el => el.classList.add('visible'));
      });
    }
  });
  window.addEventListener('resize', () => galleries.forEach(g => waterfall(g)));
});
</script>